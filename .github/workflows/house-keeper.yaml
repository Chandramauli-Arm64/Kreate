name: Chores

on:
  schedule:
    - cron: '0 0 * * 2'   # Every Tuesday at 0 AM

  # Allow manual trigger
  workflow_dispatch:

# Prevent multiple jobs from running at the same time
concurrency:
  group: 'house-keeping'
  cancel-in-progress: false  # Don't cancel any in-progress runs in this group

jobs:
  # Delete all artifacts that were created
  # 3 weeks or longer.
  clean-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Remove old builds
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '3 weeks'

  remove-success-workflows:
    runs-on: ubuntu-latest
    env:
      # Repo's path in format {OWNER}/{REPO}
      GITHUB_REPOSITORY: ${{ github.action_repository }}

    # Inspired by this article https://devblog.jpcaparas.com/bulk-delete-github-actions-workflow-runs-with-a-simple-bash-function-b9105009a579
    # Each command is run on separated step for debug purpose
    steps:
      - name: Login to Github CLI
        run: echo "${{ secrets.HOUSE_KEEPER_WORKFLOW }}" | gh auth login --with-token

      - name: Get all workflows
        run: gh api repos/"$GITHUB_REPOSITORY"/actions/runs --paginate > workflows.json

      - name: Filter success workflows
        # What workflows eligible to be deleted:
        # - Must be "completed"
        # - Must be "success"
        # - Were updated at least 2 weeks ago
        run: |
          jq -r ' 
          .workflow_runs[] | 
          select(
            .status == "completed" and 
            .conclusion == "success" and 
            (now - (.updated_at | fromdate)) < (14 * 86400)
          ) | 
          .id' workflows.json > success_workflows.txt

      - name: Send delete requests
        # Adhere to Github's rate limit of 60 requests per hour
        run: |
          count=0
          
          while IFS= read -r line; do
            if [ "$count" -eq 60 ]; then
              break
            else
              gh api -X DELETE repos/"$GITHUB_REPOSITORY"/actions/runs/$line --silent
              ((count++))
            fi
          done < success_workflows.txt
